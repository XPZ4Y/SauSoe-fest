<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Astra Rush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0c0a09;
            font-family: 'Pixelify Sans', sans-serif;
            overflow: hidden;
            touch-action: none;
            /* Disables pinch-zoom, etc., on mobile */
        }

        canvas {
            background-color: #000;
            display: block;
            cursor: none;
            image-rendering: pixelated;
            /* Ensures crisp pixels */
        }

        #game-container {
            border: 4px solid #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .ui-panel {
            background-color: rgba(0, 0, 0, 0.7);
            border: 2px solid #65a3da;
            box-shadow: 0 0 20px rgba(101, 163, 218, 0.5);
        }

        .btn {
            background-color: #f7c02b;
            color: #0c0a09;
            transition: all 0.2s ease;
            border-bottom: 4px solid #a47d3a;
        }

        .btn:hover {
            transform: translateY(-2px);
            border-bottom-width: 6px;
        }

        .btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
    </style>
</head>

<body class="flex items-center justify-center h-screen">

    <div id="game-container" class="relative w-full max-w-4xl aspect-[4/3] mx-auto">
        <canvas id="game-canvas"></canvas>

        <div id="start-screen"
            class="absolute inset-0 flex flex-col items-center justify-center bg-black/50 text-white p-8 z-10">
            <h1 class="text-6xl md:text-8xl font-bold text-center mb-4" style="text-shadow: 0 0 10px #f7c02b;">ASTRA
                RUSH</h1>
            <p class="text-xl md:text-2xl mb-8">Survive the void.</p>
            <button id="start-button" class="btn text-2xl font-bold py-3 px-8 rounded-lg">START</button>
            <div class="mt-8 text-lg text-gray-300 text-center">
                <p><span class="font-bold text-f7c02b">Controls:</span></p>
                <p>Mouse / Touch / W-S / Arrow Keys</p>
            </div>
        </div>

        <div id="game-over-screen"
            class="absolute inset-0 hidden flex-col items-center justify-center bg-black/70 text-white p-8 z-10">
            <h2 class="text-6xl md:text-8xl font-bold text-red-500 mb-4" style="text-shadow: 0 0 10px #f00;">CONSUMED BY
                THE VOID</h2>
            <p class="text-2xl mb-2">Your Score: <span id="final-score" class="font-bold text-f7c02b">0</span></p>
            <p class="text-2xl mb-8">High Score: <span id="high-score-display" class="font-bold text-f7c02b">0</span>
            </p>
            <button id="restart-button" class="btn text-2xl font-bold py-3 px-8 rounded-lg">TRY AGAIN</button>
        </div>

        <div id="score-ui" class="absolute top-4 left-4 text-white text-2xl md:text-3xl font-bold z-5"
            style="text-shadow: 2px 2px 4px #000;">
            SCORE: <span id="score">0</span>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const gameContainer = document.getElementById('game-container');

        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const scoreElement = document.getElementById('score');
        const finalScoreElement = document.getElementById('final-score');
        const highScoreDisplay = document.getElementById('high-score-display');

        let gameState = 'start';
        let score = 0;
        let highScore = localStorage.getItem('astraRushHighScore') || 0;

        let player;
        let obstacles = [];
        let particles = [];
        let stars = [];

        let gameSpeed = 2;
        let frameCount = 0;

        let musicSynth, explosionSynth;
        let musicSequence;
        let soundsInitialized = false;

        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Player {
            constructor() {
                this.width = 50;
                this.height = 30;
                this.x = 50;
                this.y = canvas.height / 2 - this.height / 2;
                this.targetY = this.y;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                for (let i = 0; i < 5; i++) {
                    const life = Math.random();
                    ctx.fillStyle = `rgba(247, 192, 43, ${life * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(-this.width / 2 + Math.random() * 10, this.height / 2, Math.random() * 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.fillStyle = '#65a3da';
                ctx.beginPath();
                ctx.moveTo(0, this.height * 0.25);
                ctx.quadraticCurveTo(this.width * 0.4, -this.height * 0.2, this.width, this.height * 0.5);
                ctx.quadraticCurveTo(this.width * 0.4, this.height * 1.2, 0, this.height * 0.75);
                ctx.closePath();
                ctx.fill();
                ctx.fillStyle = '#4b8bba';
                ctx.fillRect(this.width * 0.2, this.height * 0.2, this.width * 0.6, this.height * 0.6);
                ctx.fillStyle = '#a47d3a';
                ctx.fillRect(this.width * 0.5, 0, 4, this.height);
                ctx.restore();
            }
            update() {
                this.y += (this.targetY - this.y) * 0.2;
                if (this.y < 0) this.y = 0;
                if (this.y > canvas.height - this.height) this.y = canvas.height - this.height;
            }
        }

        class Asteroid {
            constructor() {
                this.type = 'asteroid';
                this.size = Math.random() * 50 + 20;
                this.x = canvas.width + this.size;
                this.y = Math.random() * (canvas.height - this.size);
                this.speed = Math.random() * 2 + 1;
                this.angle = 0;
                this.rotationSpeed = (Math.random() - 0.5) * 0.05;

                // Create a pixel map for the asteroid texture
                this.pixelMap = [];
                for (let i = 0; i < this.size; i++) {
                    this.pixelMap[i] = [];
                    for (let j = 0; j < this.size; j++) {
                        const dist = Math.sqrt(Math.pow(i - this.size / 2, 2) + Math.pow(j - this.size / 2, 2));
                        if (dist < this.size / 2 * (Math.random() * 0.2 + 0.8)) {
                            const rand = Math.random();
                            if (rand < 0.7) this.pixelMap[i][j] = '#6b7280'; // Gray
                            else if (rand < 0.9) this.pixelMap[i][j] = '#4b5563'; // Darker Gray
                            else this.pixelMap[i][j] = '#9ca3af'; // Lighter Gray
                        }
                    }
                }
            }
            update() { this.x -= this.speed * gameSpeed; this.angle += this.rotationSpeed; }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                for (let i = 0; i < this.size; i++) {
                    for (let j = 0; j < this.size; j++) {
                        if (this.pixelMap[i][j]) {
                            ctx.fillStyle = this.pixelMap[i][j];
                            ctx.fillRect(i - this.size / 2, j - this.size / 2, 1, 1);
                        }
                    }
                }
                ctx.restore();
            }
        }

        class Monster {
            constructor() {
                this.type = 'monster';
                this.size = 60;
                this.x = canvas.width + this.size;
                this.y = Math.random() * (canvas.height - this.size * 2) + this.size;
                this.speed = 1.5;
                this.angle = 0;
                this.amplitude = Math.random() * 40 + 20;
                this.frequency = Math.random() * 0.02 + 0.01;
            }
            update() {
                this.x -= this.speed * gameSpeed;
                this.angle += this.frequency * gameSpeed;
                this.y += Math.sin(this.angle) * 2;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                // Eye
                const eyeSize = 10 + Math.sin(this.angle * 5) * 2;
                ctx.fillStyle = '#f0f'; // Magenta glow
                ctx.beginPath();
                ctx.arc(0, 0, eyeSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#0f0'; // Green pupil
                ctx.beginPath();
                ctx.arc(0, 0, eyeSize * 0.4, 0, Math.PI * 2);
                ctx.fill();

                // Tentacles
                for (let i = 0; i < 5; i++) {
                    ctx.strokeStyle = '#4c0519'; // Deep purple
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    const angle = i * (Math.PI * 2 / 5) + this.angle;
                    const length = 20 + Math.sin(this.angle * 3 + i) * 10;
                    ctx.quadraticCurveTo(
                        Math.cos(angle - 0.5) * length, Math.sin(angle - 0.5) * length,
                        Math.cos(angle) * length * 1.5, Math.sin(angle) * length * 1.5
                    );
                    ctx.stroke();
                }
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.size = Math.random() * 3 + 1;
                this.speedX = (Math.random() - 0.5) * 4; this.speedY = (Math.random() - 0.5) * 4;
                this.color = color; this.life = 100;
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.life--; }
            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life / 100;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.globalAlpha = 1;
            }
        }

        class Star {
            constructor(layer) {
                this.layer = layer; this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 0.5 + (0.5 * layer);
                this.speed = this.size * 0.2 * layer; // Slower particles
            }
            update() {
                this.x -= this.speed * gameSpeed;
                if (this.x < 0) { this.x = canvas.width; this.y = Math.random() * canvas.height; }
            }
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${0.1 * this.layer})`;
                ctx.fillRect(this.x, this.y, this.size, this.size);
            }
        }

        function initSounds() { /* ... same as before ... */ }
        function handleParticles() { /* ... same as before ... */ }

        function handleObstacles() {
            // Spawn Asteroids
            if (frameCount % Math.max(10, Math.floor(100 / gameSpeed)) === 0) {
                obstacles.push(new Asteroid());
            }
            // Spawn Monsters rarely
            if (frameCount > 500 && Math.random() < 0.002) {
                obstacles.push(new Monster());
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].update();
                obstacles[i].draw();
                if (obstacles[i].x < -obstacles[i].size) {
                    obstacles.splice(i, 1);
                }
            }
        }

        function handleStars() {
            if (stars.length < 150) {
                for (let i = 0; i < 50; i++) stars.push(new Star(1)); // Distant
                for (let i = 0; i < 50; i++) stars.push(new Star(2)); // Mid
                for (let i = 0; i < 50; i++) stars.push(new Star(3)); // Foreground
            }
            stars.forEach(s => { s.update(); s.draw(); });
        }

        function checkCollisions() {
            for (let obstacle of obstacles) {
                const dx = (player.x + player.width / 2) - obstacle.x;
                const dy = (player.y + player.height / 2) - obstacle.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < obstacle.size / 2 + player.width / 2.5) {
                    endGame();
                }
            }
        }

        function gameLoop() {
            if (gameState !== 'playing') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            handleStars();
            player.update();
            player.draw();
            handleObstacles();
            handleParticles();
            checkCollisions();
            score++;
            scoreElement.textContent = score;
            gameSpeed += 0.001;
            frameCount++;
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            Tone.start().then(() => {
                if (!soundsInitialized) initSounds();
                gameState = 'playing';
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                player = new Player();
                obstacles = []; particles = []; score = 0;
                gameSpeed = 2; frameCount = 0;
                scoreElement.textContent = '0';
                Tone.Transport.bpm.value = 140;
                musicSequence.start(0);
                Tone.Transport.start();
                gameLoop();
            });
        }

        function endGame() {
            if (gameState === 'gameover') return;
            gameState = 'gameover';
            Tone.Transport.stop(); musicSequence.stop();
            explosionSynth.triggerAttackRelease("8n");
            createExplosion(player.x + player.width / 2, player.y + player.height / 2);

            if (score > highScore) { highScore = score; localStorage.setItem('astraRushHighScore', highScore); }
            finalScoreElement.textContent = score;
            highScoreDisplay.textContent = highScore;
            gameOverScreen.classList.remove('hidden');
        }

        // --- Simplified repeated code from before ---
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        const keys = {};
        window.addEventListener('keydown', (e) => { keys[e.key] = true; });
        window.addEventListener('keyup', (e) => { keys[e.key] = false; });
        function handlePlayerMovement() {
            if (gameState === 'playing' && player) {
                const moveSpeed = 5;
                if (keys['w'] || keys['ArrowUp']) player.targetY -= moveSpeed;
                if (keys['s'] || keys['ArrowDown']) player.targetY += moveSpeed;
            }
            requestAnimationFrame(handlePlayerMovement);
        }
        function handleMouseMove(e) {
            if (gameState === 'playing' && player) {
                const rect = canvas.getBoundingClientRect();
                player.targetY = e.clientY - rect.top - player.height / 2;
            }
        }
        function handleTouchMove(e) {
            if (gameState === 'playing' && player && e.touches.length > 0) {
                const rect = canvas.getBoundingClientRect();
                player.targetY = e.touches[0].clientY - rect.top - player.height / 2;
            }
        }
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('touchmove', handleTouchMove, { passive: true });
        handlePlayerMovement();

        // --- Functions that are exactly the same ---
        function createExplosion(x, y) {
            for (let i = 0; i < 30; i++) {
                particles.push(new Particle(x, y, '#f7c02b'));
                particles.push(new Particle(x, y, '#65a3da'));
            }
        }
        function initSounds() {
            if (soundsInitialized) return;
            const reverb = new Tone.Reverb(0.7).toDestination();
            musicSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2, release: 0.2 }, modulationEnvelope: { attack: 0.01, decay: 0.3, release: 0.2 } }).connect(reverb);
            const notes = ["C3", "Eb3", "G3", "Bb3", "G3", "Eb3"];
            musicSequence = new Tone.Sequence((time, note) => { musicSynth.triggerAttackRelease(note, "16n", time); }, notes, "8n");
            explosionSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0 } }).toDestination();
            soundsInitialized = true;
        }

    </script>
</body>

</html>